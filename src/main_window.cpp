#include "main_window.h"

#include <QColor>
#include <QHBoxLayout>
#include <QMetaObject>
#include <QScreen>
#include <QVBoxLayout>


MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , m_mapScene(new QQuickWidget(QUrl(QStringLiteral("qrc:/src/map.qml"))))
    , m_controlPanel(new ControlPanel)
{
    loadFonts();
    initControls();
    initLayouts();

    QRect screenRect = QGuiApplication::primaryScreen()->availableGeometry();
    int   dx         = 20;
    int   dy         = 50;
    setGeometry(screenRect.x() + dx, screenRect.y() + dy, screenRect.width() - 2 * dx, screenRect.height() - 2 * dy);
    this->showMaximized();

    test(); // !!! потом удалить !!!
}

MainWindow::~MainWindow() {}

void MainWindow::loadFonts()
{
    this->setFont(FontManager::instance().regular(GuiConfig::FONT_SIZE_NORMAL));
}

void MainWindow::initControls()
{
    m_mapScene->setResizeMode(QQuickWidget::SizeRootObjectToView);
    m_mapScene->setMinimumWidth(512);
    m_mapScene->setMinimumHeight(512);
}

void MainWindow::initLayouts()
{
    // tab 1:

    QWidget *    tab1Widget = new QWidget;
    QHBoxLayout *tab1Layout = new QHBoxLayout;
    tab1Layout->setMargin(GuiConfig::LAYOUT_MARGIN_SMALL);
    tab1Layout->setSpacing(GuiConfig::LAYOUT_SPACING_SMALL);
    tab1Layout->addWidget(m_mapScene);
    tab1Layout->addWidget(m_controlPanel);
    tab1Widget->setLayout(tab1Layout);

    // tab 2:

    QWidget *    tab2Widget = new QWidget;
    QHBoxLayout *tab2Layout = new QHBoxLayout;
    tab2Layout->setMargin(GuiConfig::LAYOUT_MARGIN_SMALL);
    tab2Layout->setSpacing(GuiConfig::LAYOUT_SPACING_SMALL);
    tab2Widget->setLayout(tab2Layout);

    // main:

    QTabWidget *mainWidget = new QTabWidget;
    mainWidget->addTab(tab1Widget, tr("Карта"));
    mainWidget->addTab(tab2Widget, tr("Другое"));

    setCentralWidget(mainWidget);

    centralWidget()->setMinimumWidth(3 * GuiConfig::LAYOUT_MARGIN_BIG + m_mapScene->minimumWidth() +
                                     m_controlPanel->minimumWidth());
    setMinimumWidth(this->layout()->margin() * 2 + centralWidget()->minimumWidth());
}

void MainWindow::addCircle(QVariant latitude, QVariant longitude, QVariant color, QVariant borderColor, QVariant radius)
{
    QVariant returnedValue;
    QMetaObject::invokeMethod((QObject *)(m_mapScene->rootObject()), "addCircle", Q_RETURN_ARG(QVariant, returnedValue),
                              Q_ARG(QVariant, latitude), Q_ARG(QVariant, longitude), Q_ARG(QVariant, color),
                              Q_ARG(QVariant, borderColor), Q_ARG(QVariant, radius));
}

// slots:

void MainWindow::onClear() {}


void MainWindow::test()
{
    QColor c1(100, 120, 200, 128);
    QColor c2(100, 120, 200, 255);

    struct Coord {
        double x;
        double y;
    };
    QVector<Coord> coordinates = {
        {53.7167, 91.4667}, {71.6164, 52.4106}, {51.5161, 59.9367},   {58.6167, 125.417},  {69.7631, 61.6678},
        {44.8667, 37.3667}, {64.7333, 177.517}, {60.46, 169.579},     {67.5667, 33.4},     {64.5333, 40.5333},
        {46.35, 48.05},     {65.9333, 111.483}, {61.0031, 170.505},   {63.7266, 167.585},  {56.4583, 138.168},
        {53.3333, 83.75},   {56.1167, 43.5},    {50.25, 127.533},     {57.8667, 114.2},    {50.6, 36.6},
        {63.9344, 65.0444}, {61.6667, 96.3667}, {63.7167, 66.6667},   {63.0497, 179.31},   {69.4, 70.2},
        {61.0775, 80.7967}, {56.1167, 101.6},   {53.2333, 34.3667},   {67.65, 134.65},     {54.5364, 52.7975},
        {44.9195, 147.622}, {61.8161, 92.6432}, {60.7542, 76.8108},   {68.55, 146.183},    {57.9347, 69.0136},
        {43.1333, 131.9},   {48.7, 44.5167},    {59.2167, 39.9},      {60.7667, 46.3},     {57.0333, 70.1167},
        {63.75, 121.633},   {59.4333, 112.567}, {67.5, 64.0333},      {43.0167, 44.65},    {56.1333, 40.4167},
        {60.8667, 76.6167}, {64.5386, 48.4489}, {51.6717, 39.2106},   {60.3333, 102.267},  {63.7, 57.3167},
        {63.45, 120.3},     {44.5667, 38.0833}, {51.5467, 118.341},   {51.95, 85.9667},    {43.3167, 45.7167},
        {66.0444, 43.4551}, {69.3167, 139.983}, {73.5, 80.5167},      {45.9333, 133.733},  {50.7664, 59.5444},
        {44.55, 135.583},   {61.2667, 108.017}, {56.8333, 60.5833},   {68.4652, 102.189},  {46.7, 38.2833},
        {56.5833, 104.133}, {66.7667, 123.383}, {65.6667, -171.083},  {65.75, 150.9},      {52.6628, 84.9372},
        {56.9967, 40.9819}, {67.4667, 86.5833}, {56.8333, 53.1833},   {52.2833, 104.283},  {66.0833, 60.1333},
        {43.2167, 44.7667}, {63.1875, 64.4117}, {56.65, 47.8833},     {44.2667, 135.05},   {52.0817, 59.7328},
        {55.4667, 65.35},   {58.0846, 66.5413}, {48.5167, 34.6167},   {62.3107, 92.1343},  {58.6076, 99.177},
        {55.7964, 49.1089}, {56.295, 107.383},  {58.603, 49.6572},    {61.5383, 82.3898},  {64.7654, 47.599},
        {45.2167, 147.883}, {65.7056, 82.46},   {54.55, 36.2833},     {54.7003, 20.4531},  {50.1, 118.033},
        {62.2667, 74.4833}, {66.3795, 42.5391}, {57.7667, 40.9333},   {63.4589, 48.8936},  {67.8167, 166.1},
        {55.3667, 86.0667}, {57.7833, 108.083}, {45.0333, 38.9667},   {50.5667, 137},      {50.3636, 108.757},
        {63.5892, 103.954}, {53.4944, 50.3971}, {61.25, 46.6333},     {71.2813, 99.3997},  {51.7167, 36.1833},
        {71.5117, 103.21},  {59.9833, 45.8167}, {51.7167, 94.45},     {60.9588, 96.9684},  {56.0167, 93.0667},
        {58.4105, 67.463},  {64.9515, 36.8255}, {64.8958, 45.766},    {52.6167, 39.6},     {61.1006, 80.2575},
        {60.7333, 114.917}, {64.9714, 37.6919}, {58.3167, 112.9},     {65.7736, 46.1792},  {60.3167, 99.3667},
        {53.3833, 59.0333}, {59.5667, 150.8},   {65.8333, 44.2667},   {62.4908, 165.33},   {62.5289, 113.95},
        {68.469, 73.5963},  {64.6667, 170.417}, {55.75, 37.6167},     {66.4554, 143.223},  {44.2167, 43.1333},
        {61.3258, 100.493}, {68.9667, 33.0833}, {42.9667, 47.4833},   {68.8683, -179.373}, {71.7456, 101.244},
        {53.7667, 87.1333}, {51.8125, 143.167}, {65.5333, 72.5167},   {6.60194, 44.676},   {60.95, 76.6},
        {55.7667, 109.517}, {54.9333, 99},      {55.6333, 51.8167},   {56.3269, 44.0075},  {71.4333, 136.067},
        {55.2, 165.983},    {64.1333, 99.9167}, {65.0671, 117.114},   {53.1333, 140.733},  {57.6542, 136.171},
        {67.6333, 53.05},   {63.2, 75.45},      {66.752, 47.7559},    {56.6833, 124.667},  {69.3333, 88.2167},
        {72.8377, 105.842}, {48.849, 134.31},   {66.0833, 76.6833},   {43.4833, 43.6167},  {63.2833, 118.333},
        {62.1333, 65.3833}, {55.011, 82.9715},  {51.4992, 156.544},   {60.2639, 100.481},  {60.3667, 120.417},
        {68.5, 112.467},    {66.6427, 46.4924}, {63.4608, 142.786},   {54.9833, 73.3667},  {51.7833, 55.1},
        {65.2667, 160.467}, {51.2, 58.5667},    {59.2469, 163.063},   {62.5333, 155.8},    {53.5833, 142.933},
        {59.3675, 143.259}, {60.3685, 98.3048}, {59.0833, 159.933},   {60.555, 169.14},    {49.05, 134.333},
        {61.9893, 94.6558}, {69.7, 170.283},    {42.8833, 133.883},   {44.75, 136.283},    {66.3961, 112.2997},
        {53.2, 45},         {52.4167, 136.5},   {64.4246, -173.2175}, {53.0167, 158.65},   {58, 56.3167},
        {57.8167, 28.3333}, {61.7833, 34.3333}, {64.795, 38.4128},    {61.5944, 90.1333},  {61.1006, 80.2575},
        {60.9987, 75.4857}, {57.6683, 66.3154}, {65.1667, 57.25},     {55.5667, 38.2167},  {47.2333, 39.7},
        {66.0388, 41.2246}, {63.9167, 127.467}, {61.6089, 91.1821},   {54.2992, 155.933},  {61.6041, 80.9417},
        {71.2468, 72.1029}, {61.917, 159.233},  {73.2602, 108.21},    {62.5621, 97.3835},  {54.95, 20.15},
        {60.3754, 93.035},  {52.694, 58.6502},  {44.9411, 34.1043},   {67.7983, 130.401},  {50.8, 60.9167},
        {63.162, 167.973},  {58.0794, 93.0319}, {62.9308, 152.385},   {53.1775, 50.1715},  {48.9667, 140.283},
        {65.03, 35.7333},   {61.3614, 63.5842}, {51.3, 37.8333},      {60.3, 137.55},      {43.5853, 39.7203},
        {65.7792, 43.3925}, {50.4333, 80.2667}, {59.95, 30.3168},     {60.8278, 169.064},  {67.4667, 153.717},
        {54.1833, 45.1833}, {51.5333, 46.0167}, {62.7833, 148.167},   {45.05, 41.9833},    {60.7333, 77.5833},
        {62.1667, 117.633}, {61.25, 73.4333},   {55.1167, 33.25},     {66.5333, 66.6},     {52.05, 113.467},
        {61.738, 102.796},  {61.6667, 50.8167}, {71.9653, 114.092},   {47.2167, 38.9167},  {64.2833, 100.217},
        {58.2, 68.2667},    {53.5294, 115.597}, {45.0333, 136.6},     {67.4833, 78.7167},  {57.7614, 158.676},
        {60.4333, 166.049}, {56.3667, 114.917}, {64.9167, 77.8},      {58.2827, 67.091},   {62.0501, 166.701},
        {52.7167, 41.4333}, {64.2175, 93.7892}, {54.5333, 135.817},   {65.797, 87.968},    {49.4376, 136.553},
        {71.65, 128.867},   {56.5, 84.9667},    {53.7667, 136.833},   {57.6846, 68.4243},  {62.7167, 56.2},
        {55.1667, 124.717}, {64.0025, 82.0511}, {57.15, 65.5333},     {54.5, 134.4},       {70, 135.583},
        {56.2167, 162.55},  {54.3167, 48.3667}, {51.8333, 107.6},     {63.8167, 96.45},    {64.5833, 143.25},
        {60.1333, 64.8},    {51.2333, 51.3667}, {54.4422, 116.522},   {56.7833, 105.633},  {60.4167, 134.55},
        {66, 57.5333},      {52.6549, 115.257}, {61.1097, 78.2506},   {58, 102.667},       {65.4333, 52.15},
        {54.7333, 56},      {57.1014, 156.754}, {63.5667, 53.7},      {60.9556, 166.842},  {61, 69},
        {71.9797, 102.473}, {48.4833, 135.083}, {40.2833, 69.6333},   {62.6667, 135.55},   {52.9794, 138.837},
        {71.9833, 102.5},   {56.9167, 118.267}, {57.726, 68.2113},    {56.15, 47.2333},    {51.1167, 133.017},
        {59.6258, 103.328}, {61.1103, 80.5822}, {67.0877, 44.3832},   {67.55, 100.383},    {70.6333, 147.9},
        {55.1547, 61.3758}, {54.7, 135.283},    {59.1167, 37.9},      {68.7667, 161.333},  {49.1667, 142.117},
        {67.8778, 44.1547}, {53.3258, 91.9422}, {66.3183, -179.123},  {65.7667, 105.333},  {46.3167, 44.2667},
        {44.0333, 145.85},  {46.9667, 142.733}, {63.3803, 105.671},   {53.6123, 114.039},  {62.0333, 129.733},
        {67.9046, 74.8566}, {58.3604, 66.6514}, {57.6167, 39.85}};

    for (int i = 0; i < coordinates.count(); ++i) {
        addCircle(coordinates[i].x, coordinates[i].y, c1, c2, 5);
    }
}
